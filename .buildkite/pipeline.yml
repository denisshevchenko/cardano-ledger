env:
  BUILD_DIR: "/build/cardano-ledger"
  STACK_ROOT: "/build/cardano-ledger.stack"
  CACHE_DIR: "/cache/cardano-ledger"

steps:
  - label: 'stack rebuild'
    command:
      - "nix-build scripts/buildkite/default.nix -o sr"
      - "./sr/bin/rebuild --build-dir=$BUILD_DIR --cache-dir=$CACHE_DIR"
    agents:
      system: x86_64-linux
    timeout_in_minutes: 120
    artifact_paths:
      - "/build/cardano-ledger/.stack-work/logs/cardano-ledger*.log"

  - label: Check Hydra evaluation of release.nix
    commands:
      - "nix-build -A iohkLib.check-hydra -o check-hydra.sh"
      - "./check-hydra.sh"
    agents:
      system: x86_64-linux

  - label: Check auto-generated Nix
      - "nix-build -A iohkLib.check-nix-tools -o check-nix-tools.sh"
      - "./check-nix-tools.sh"
    agents:
      system: x86_64-linux

  - label: Check that cabal.project and stack.yaml have consistent git hashes for dependencies
    command: 'nix-shell --run scripts/buildkite/stack-cabal_config_check.sh'
    agents:
      system: x86_64-linux
